{# Integrated-Web-UI-main/web/templates/index.html #}
{% extends "base.html" %}
{% block title %}Wi-Fi Intel{% endblock %}

{% block content %}
<div class="container mt-4 bg-light border rounded p-3" style="min-height:200px;">

  <ul class="nav nav-tabs nav-fill justify-content-center" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="report-tab"
              data-bs-toggle="tab" data-bs-target="#report-pane"
              type="button" role="tab" aria-controls="report-pane" aria-selected="true">
        Wi-Fi Report
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="heat-tab"
              data-bs-toggle="tab" data-bs-target="#heat-pane"
              type="button" role="tab" aria-controls="heat-pane" aria-selected="false">
        Heat Map
      </button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- REPORT TAB -->
    <div class="tab-pane fade show active" id="report-pane" role="tabpanel" aria-labelledby="report-tab">
      <h2 class="my-3 text-center">Wi-Fi Analysis Report</h2>

      <form method="get" action="{{ url_for('index') }}" class="mb-3">
        <div class="d-flex justify-content-center flex-wrap gap-2">

          <!-- Project selector -->
          <select name="pid" id="pid" class="form-select" style="max-width:120px" onchange="this.form.submit()">
            <option value="">Proj</option>
            {% for project in project_ids %}
              <option value="{{ project }}" {% if project|string == selected_pid|string %}selected{% endif %}>
                {{ project }}
              </option>
            {% endfor %}
          </select>

          <!-- SSID selector -->
          <select name="q" id="q" class="form-select" style="max-width:420px" onchange="this.form.submit()">
            <option value="">-- Select SSID --</option>
            {% for ssid in ssids %}
              <option value="{{ ssid }}" {% if ssid|string == selected_q|string %}selected{% endif %}>
                {{ ssid }}
              </option>
            {% endfor %}
          </select>

          <button type="submit" class="btn btn-primary">Search</button>

          <!-- Correct route for PDF download -->
          <a
            href="{{ url_for('download', project_id=selected_pid, ssid=selected_q) }}"
            class="btn btn-success {% if not selected_pid %}disabled{% endif %}"
            {% if not selected_pid %}aria-disabled="true" tabindex="-1"{% endif %}>>
            Download PDF
          </a>

          <a href="{{ url_for('index') }}" class="btn btn-secondary">Reset</a>
        </div>
      </form>

      {# Flash messages #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mt-3">
            {% for category, message in messages %}
              <div class="alert alert-{{ 'danger' if category == 'error' or category == 'danger' else category }}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {# Results table #}
      {% if macs and macs|length %}
        <div class="table-responsive">
          <h2 class="mt-4 mb-3 text-center">
            MACs for SSID: {{ selected_q or '(hidden)' }}
          </h2>

          <table class="table table-striped table-hover table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th scope="col">MAC (Source)</th>
                <th scope="col">Frames</th>
                <th scope="col">First Seen</th>
                <th scope="col">Last Seen</th>
                <th scope="col">Min RSSI</th>
                <th scope="col">Avg RSSI</th>
                <th scope="col">Max RSSI</th>
                <th scope="col">Encryption</th>
                <th scope="col">Authentication</th>
              </tr>
            </thead>
            <tbody>
              {% for r in macs %}
                <tr>
                  <td>{{ r.mac or r['mac'] }}</td>
                  <td>{{ r.frames or r['frames'] }}</td>
                  <td>{{ r.first_seen or r['first_seen'] }}</td>
                  <td>{{ r.last_seen or r['last_seen'] }}</td>
                  <td>{{ r.min_rssi or r['min_rssi'] }}</td>
                  <td>{{ r.avg_rssi or r['avg_rssi'] }}</td>
                  <td>{{ r.max_rssi or r['max_rssi'] }}</td>
                  <td>{{ r.enc_types or r['enc_types'] }}</td>
                  <td>{{ r.auth_modes or r['auth_modes'] }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% elif selected_pid or selected_q %}
        <p class="text-center text-muted">No data for the chosen filters.</p>
      {% endif %}
    </div>

    <!-- HEATMAP TAB -->
    <div class="tab-pane fade" id="heat-pane" role="tabpanel" aria-labelledby="heat-tab">
      <h2 class="my-3 text-center">Wi-Fi Heat Map</h2>
      <div class="text-center mb-3 ratio ratio-16x9">
        <iframe
          src="{{ url_for('heatmap') }}"
          allowfullscreen
          style="border:none;"
          class="w-100"
          title="Wi-Fi Heat Map">
        </iframe>
      </div>
    </div>
  </div>
</div>
{% endblock %}
