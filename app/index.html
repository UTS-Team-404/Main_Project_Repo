<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Heatmap Application</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #0a1a2f; /* Dark blue */
      color: white;
    }

    .navbar {
      display: flex;
      background-color: #07182d;
      padding: 1rem;
      justify-content: center;
      gap: 1rem;
    }

    .navbar a {
      background-color: white;
      color: #0a1a2f; /* Dark blue text */
      text-decoration: none;
      padding: 0.6rem 1.2rem;
      border-radius: 25px; /* Rounded */
      font-weight: bold;
      transition: background-color 0.3s, color 0.3s;
    }

    .navbar a:hover,
    .navbar a.active {
      background-color: #133b5c;
    }

    .page {
      display: none;
      padding: 2rem;
    }

    .page.active {
      display: block;
    }

    #heatmap-container {
      height: 600px;
      width: 100%;
    }

    .wifi-card {
      background-color: #122943;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 6px;
    }
  </style>

  <!-- Load Leaflet and Heatmap plugins (from CDN) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
</head>
<body>

  <!-- Navbar -->
  <div class="navbar">
    <a href="#" class="nav-link active" data-page="home">Home</a>
    <a href="#" class="nav-link" data-page="wifi">WiFi</a>
    <a href="#" class="nav-link" data-page="heatmap">Heatmap</a>
  </div>

  <!-- Pages -->
  <div id="home" class="page active">
    <h1>Welcome</h1>
    <p>This application shows WiFi signal strength using a heatmap.</p>
  </div>

  <div id="wifi" class="page">
    <h1>WiFi Networks</h1>
    <div id="table-container">Loading...</div>
  </div>
   
   <script>
        async function updateTable() {
            try {
                const tableHTML = await window.pywebview.api.get_csv_table();
                document.getElementById('table-container').innerHTML = tableHTML;
            } catch (e) {
                console.error('Error fetching table:', e);
            }
        }

        window.onload = () => {
            updateTable(); // Initial load
            setInterval(updateTable, 5000); // Update every 5 sec
        };
    </script>

  <div id="heatmap" class="page">
    <h1>Heatmap</h1>
    <div id="heatmap-container"></div>
  </div>

  <script>
    // Navigation
    const links = document.querySelectorAll('.nav-link');
    const pages = document.querySelectorAll('.page');

    links.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetPage = link.dataset.page;

        // Toggle active link and page
        links.forEach(l => l.classList.remove('active'));
        pages.forEach(p => p.classList.remove('active'));
        link.classList.add('active');
        document.getElementById(targetPage).classList.add('active');

        // Lazy-load heatmap when navigated to
        if (targetPage === 'heatmap' && !window.heatmapInitialized) {
          initHeatmap();
        }
      });
    });

    // WiFi Page: Load data from Python backend
    async function loadWiFiData() {
      const container = document.getElementById('wifi-content');
      container.innerHTML = 'Loadingssss...';

      try {
        const wifiData = await window.pywebview.api.get_wifi_data().then(showResponse);

        if (!wifiData.length) {
          container.innerHTML = '<p>No WiFi data found.</p>';
          return;
        }

        container.innerHTML = '';
        wifiData.forEach(wifi => {
          const div = document.createElement('div');
          div.className = 'wifi-card';
          div.innerHTML = `
            <strong>SSID:</strong> ${wifi.ssid}<br>
            <strong>Signal Strength:</strong> ${wifi.signal_strength}<br>
            <strong>Channel:</strong> ${wifi.channel}<br>
            <strong>Encryption:</strong> ${wifi.encryption}
          `;
          container.appendChild(div);
        });
      } catch (error) {
        container.innerHTML = '<p>Error loading WiFi data.</p>';
        console.error(error);
      }
    }

    // Heatmap Page: Load and plot heatmap
    async function initHeatmap() {
      const container = document.getElementById('heatmap-container');

      try {
        const response = await fetch('data.csv');
        const text = await response.text();
        const data = parseCSV(text);

        if (!data.length) {
          container.innerHTML = '<p>No data for heatmap.</p>';
          return;
        }

        // Create Leaflet map
        const avgLat = data.reduce((sum, d) => sum + d[0], 0) / data.length;
        const avgLon = data.reduce((sum, d) => sum + d[1], 0) / data.length;
        const map = L.map('heatmap-container').setView([avgLat, avgLon], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Adjust signal strength for visibility
        const heatData = data.map(d => [d[0], d[1], Math.max(0, 100 + d[2])]);

        L.heatLayer(heatData, { radius: 25 }).addTo(map);

        window.heatmapInitialized = true;
      } catch (error) {
        container.innerHTML = '<p>Error loading heatmap data.</p>';
        console.error(error);
      }
    }

    // CSV Parser: expects headers latitude,longitude,signal_strength
    function parseCSV(csvText) {
      const lines = csvText.trim().split('\n');
      const headers = lines[0].split(',');
      const latIdx = headers.indexOf('latitude');
      const lonIdx = headers.indexOf('longitude');
      const sigIdx = headers.indexOf('signal_strength');

      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const parts = lines[i].split(',');
        const lat = parseFloat(parts[latIdx]);
        const lon = parseFloat(parts[lonIdx]);
        const sig = parseFloat(parts[sigIdx]);

        if (!isNaN(lat) && !isNaN(lon) && !isNaN(sig)) {
          data.push([lat, lon, sig]);
        }
      }

      return data;
    }

    // On initial load
    window.onload = () => {
      if (window.pywebview) {
        loadWiFiData();
      }
    };
  </script>
</body>
</html>
